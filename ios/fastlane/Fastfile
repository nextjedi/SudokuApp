# iOS Fastlane Configuration
# This file contains the fastlane.tools configuration

default_platform(:ios)

platform :ios do

  # ============================================
  # LANES FOR BUILDING
  # ============================================

  desc "Build iOS app for alpha testing (TestFlight Internal)"
  lane :build_alpha do
    setup_signing

    gym(
      scheme: "sudokustreak", # Replace with your Xcode scheme
      export_method: "app-store",
      output_directory: "./build",
      output_name: "SudokuStreak-alpha.ipa",
      clean: true,
      export_options: {
        provisioningProfiles: {
          ENV['APP_IDENTIFIER'] => ENV['PROVISIONING_PROFILE_SPECIFIER']
        }
      }
    )
  end

  desc "Build iOS app for beta testing (TestFlight External)"
  lane :build_beta do
    setup_signing

    gym(
      scheme: "sudokustreak",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "SudokuStreak-beta.ipa",
      clean: true,
      export_options: {
        provisioningProfiles: {
          ENV['APP_IDENTIFIER'] => ENV['PROVISIONING_PROFILE_SPECIFIER']
        }
      }
    )
  end

  desc "Build iOS app for production (App Store)"
  lane :build_production do
    setup_signing

    gym(
      scheme: "sudokustreak",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "SudokuStreak.ipa",
      clean: true,
      export_options: {
        provisioningProfiles: {
          ENV['APP_IDENTIFIER'] => ENV['PROVISIONING_PROFILE_SPECIFIER']
        }
      }
    )
  end

  # ============================================
  # LANES FOR DEPLOYMENT
  # ============================================

  desc "Deploy to TestFlight (Internal Testing)"
  lane :deploy_alpha do
    build_alpha
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      groups: ["Internal Testers"]
    )
  end

  desc "Deploy to TestFlight (External Beta)"
  lane :deploy_beta do
    build_beta
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      distribute_external: true,
      groups: ["Beta Testers"]
    )
  end

  desc "Deploy to App Store"
  lane :deploy_production do
    build_production
    upload_to_app_store(
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: false,
      automatic_release: false
    )
  end

  # ============================================
  # UTILITY LANES
  # ============================================

  desc "Setup code signing with Fastlane Match"
  lane :setup_signing do
    match(
      type: "appstore",
      readonly: true,
      app_identifier: ENV['APP_IDENTIFIER']
    )
  end

  desc "Sync certificates and provisioning profiles"
  lane :sync_certificates do
    match(
      type: "appstore",
      readonly: false,
      app_identifier: ENV['APP_IDENTIFIER']
    )
  end

  desc "Run tests"
  lane :test do
    run_tests(
      scheme: "sudokustreak"
    )
  end

  desc "Increment build number"
  lane :bump_build do
    increment_build_number(xcodeproj: "sudokustreak.xcodeproj")
  end

end
